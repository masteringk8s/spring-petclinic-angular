library identifier: 'pipeline-library@master', retriever: modernSCM(
    [$class: 'GitSCMSource', 
    credentialsId: '', 
    id: 'pipeline-library', 
    remote: 'https://github.com/devopspatterns/pipeline-library.git', 
    traits: [[$class: 'jenkins.plugins.git.traits.BranchDiscoveryTrait']]
]) 

pipeline {
    agent {
        kubernetes {
            label 'kubernetes'
            containerTemplate {
                name 'angular-cli'
                image 'emcconne/angular-cli:latest'
                ttyEnabled true
                command 'cat'
            }
        }
    }
    
    options {
        // General Jenkins job properties
        buildDiscarder(logRotator(numToKeepStr:'5'))
    }

    stages {
        
        stage('Build and Package') {
            steps {
                container('angular-cli') {
                    sh """
                      npm install
                      ng build --environment=prod
                    """
                    archiveArtifacts 'dist/**'
                    publishAngularApp()
                    publishNodeEvent()
                }
            }
        }
    }
}

def publishAngularApp() {
    echo "Publishing application for Angular build"
    try {
        def json = readJSON file: 'package.json'
        VERSION = json['version']
        APP_NAME = json['name']
       
        echo "Building $APP_NAME"
        echo "Building Version=$VERSION"
        
    } catch (e) {
        echo "Cannot access package.json file"
        throw e
    }
}
